import{r as f,j as i}from"./vendor-react-qTQEQa1M.js";import{I as T}from"./services-CtNDYofV.js";import{u as G,g as D,s as u,b as $,a as U,H as C,P as A,I as H,F as L}from"./components-SDB2xlms.js";const k=()=>{const[h,g]=f.useState([]),[w,v]=f.useState(!1),{user:y,isConfigured:l}=G(),n=D(y),m=f.useCallback(async()=>{if(!(!l||!n||!u)){v(!0);try{const{data:s,error:t}=await u.from("saved_images").select("*").eq("user_id",n).order("created_at",{ascending:!1});if(t)throw console.error("Fetch saved images error:",t),t;const a=(s||[]).filter(o=>!o||typeof o!="object"||!o.id?(console.warn("Invalid image data found:",o),!1):!0);console.log("Valid images loaded:",a.length,"out of",(s||[]).length),g(a)}catch(s){console.error("Fetch saved images error:",s)}finally{v(!1)}}},[l,n]);return f.useEffect(()=>{n&&l?m():g([])},[n,l,m]),{savedImages:h,loading:w,saveImage:async(s,t,a,o)=>{if(!l||!n||!u)return null;try{const e=await fetch(t);if(!e.ok)throw console.error(`Failed to fetch generated image for saving. Status: ${e.status}, URL: ${t}`),new Error(`Failed to fetch generated image for saving. Status: ${e.status}`);const r=await e.blob();if(!r.type.startsWith("image/"))throw console.error(`Generated image is not a valid image type: ${r.type}, URL: ${t}`),new Error(`Generated image is not a valid image type: ${r.type}`);if(r.size===0)throw console.error(`Generated image is empty (0 bytes), URL: ${t}`),new Error("Generated image is empty (0 bytes). The image generation service may be experiencing issues. Please try again.");const c=r.type.split("/")[1]||"jpg",d=`${Date.now()}.${c}`,j=`${n}/${d}`,I=await $(),{error:E}=await I?.storage.from("generated_images").upload(j,r,{cacheControl:"3600",upsert:!1,contentType:r.type||"image/jpeg"})||{error:new Error("Storage client not available")};if(E)throw E;const{data:{publicUrl:N}}=I?.storage.from("generated_images").getPublicUrl(j)||{data:{publicUrl:""}};if(!N)throw new Error("Failed to get public URL for the uploaded image.");const F={user_id:n,prompt:s,image_url:N,aspect_ratio:a,style:o,is_favorite:!1,storage_file_path:j},{data:p,error:S}=await u.from("saved_images").insert([F]).select().single();if(S)throw console.error("Database insert error:",S),S;return p&&typeof p=="object"&&p.id&&g(P=>[p,...P]),p}catch(e){return console.error("Save image error:",e),null}},deleteImage:async s=>{if(!(!l||!n||!u))try{const t=h.find(e=>e.id===s);if(!t)return;let a=t.storage_file_path;if(!a){const e=t.image_url.split("/"),r=e.indexOf("generated_images");r!==-1&&(a=e.slice(r+1).join("/"))}if(a&&a.includes("undefined")&&(console.warn("Invalid file path detected, skipping storage deletion:",a),a=null),a)try{const e=a.startsWith("/")?a.slice(1):a;console.log("Attempting to delete file from storage:",e),console.log("File path details:",{original:a,cleaned:e,userId:n});const r=await $(),{data:c,error:d}=await r?.storage.from("generated_images").remove([e])||{data:null,error:new Error("Storage client not available")};console.log("Storage deletion response:",{removeData:c,storageError:d}),d?console.warn("Storage deletion failed:",d):console.log("Successfully deleted file from storage:",e)}catch(e){console.warn("Storage deletion error:",e)}else console.warn("No file path available for storage deletion");const{error:o}=await u.from("saved_images").delete().eq("id",s).eq("user_id",n);if(o)throw o;g(e=>e.filter(r=>r.id!==s))}catch(t){throw t}},toggleFavorite:async s=>{if(!(!l||!n||!u))try{const t=h.find(r=>r.id===s);if(!t){console.warn("Image not found for favorite toggle:",s);return}const a=!t.is_favorite;console.log("Toggling favorite for image:",s,"from",t.is_favorite,"to",a);const{data:o,error:e}=await u.from("saved_images").update({is_favorite:a}).eq("id",s).eq("user_id",n).select().single();if(e)throw console.error("Error updating favorite status:",e),e;console.log("Database update successful, received data:",o),g(r=>r.map(c=>c.id===s?o&&typeof o=="object"&&o.id?(console.log("Updating image with database data:",o),o):(console.log("Updating image locally with new favorite status"),{...c,is_favorite:a}):c))}catch(t){throw console.error("Toggle favorite error:",t),t}},refreshImages:m}},q=()=>{const[h,g]=f.useState([]),[w,v]=f.useState(!1),{saveImage:y}=k(),{user:l,isConfigured:n}=G(),{showSuccess:m,showError:b,showWarning:x}=U(),_=f.useRef(l);f.useEffect(()=>{_.current&&!l&&g([]),_.current=l},[l]);const s=async(t,a,o)=>{v(!0);const e={id:`loading_${Date.now()}`,url:"",prompt:t,timestamp:new Date,isLoading:!0,aspectRatio:o||"1:1"};g(r=>[e,...r]);try{const r=await T.generateImage({prompt:t,style:a,aspectRatio:o});if(g(c=>c.map(d=>d.id===e.id?r:d)),m("Image Generated Successfully!",`Created a ${o||"1:1"} image with ${a||"vivid"} style.`),n&&l)try{await y(t,r.url,o||"1:1",a||"vivid"),m("Image Saved!","Your generated image has been saved to your history.")}catch(c){const d=c instanceof Error?c.message:"Unknown error occurred";d.includes("empty (0 bytes)")?x("Image Generation Issue","The image generation service returned an empty image. This may be a temporary issue. Please try again with a different prompt or try again later."):x("Image Generated but Not Saved",`The image was created successfully but could not be saved to your history. ${d}`)}}catch(r){r instanceof Error?b("Image Generation Failed",r.message):b("Image Generation Failed","An unexpected error occurred. Please try again."),g(c=>c.filter(d=>d.id!==e.id))}finally{v(!1)}};return i.jsxs("div",{className:"min-h-screen",children:[i.jsxs("div",{className:"fixed inset-0 overflow-hidden pointer-events-none",children:[i.jsx("div",{className:"absolute -top-40 -right-40 w-80 h-80 bg-purple-500/20 rounded-full blur-3xl"}),i.jsx("div",{className:"absolute -bottom-40 -left-40 w-80 h-80 bg-blue-500/20 rounded-full blur-3xl"})]}),i.jsxs("div",{className:"relative z-10",children:[i.jsx(C,{}),n&&l&&i.jsx("div",{className:"max-w-4xl mx-auto px-4 mb-6",children:i.jsx("div",{className:"glass rounded-2xl p-4 border-l-4 border-green-500",children:i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("div",{className:"w-6 h-6 bg-green-500 rounded-full flex items-center justify-center",children:i.jsx("span",{className:"text-white text-sm font-bold",children:"âœ“"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-green-200 font-medium",children:"Authentication Active"}),i.jsx("p",{className:"text-green-300 text-sm",children:"Your generated images are automatically saved to your history!"})]})]})})}),i.jsx(A,{onGenerate:s,isGenerating:w}),i.jsx(H,{images:h}),i.jsx(L,{})]})]})},W=Object.freeze(Object.defineProperty({__proto__:null,default:q},Symbol.toStringTag,{value:"Module"}));export{W as H,k as u};
